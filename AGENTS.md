## Project Overview

TabScript transpiler converts indentation-based TabScript to TypeScript/JavaScript. Semantically identical to TypeScript, ideal for DSLs with full TypeScript type system support. Includes plugin system, VSCode extension with language server, and browser runtime.

## Build & Test

```bash
npm run build # Compile to dist/, minify to dist-min/
npm test # Run diff-based tests (requires build)
./dist/cli.js <input.tab> [--output <file>] [--debug] [--recover] [--js] [--whitespace preserve|pretty]

npm run build-docs # Generate TypeDoc docs with live code editor
npm run deploy-docs # Deploy to production

npm run build-extension # Build transpiler + VSCode extension
npm run watch-extension # Auto-rebuild on changes
cd vscode-extension && npx vsce package # Package for publishing
```

### VSCode Extension Test
Press **F5** in VSCode to launch extension dev window, open `.tab` files to test.

### Extension Files
- `vscode-extension/src/extension.ts` - Entry point, starts language server
- `vscode-extension/src/server.ts` - Transpiles TabScriptâ†’TypeScript in memory, provides IntelliSense
- `vscode-extension/tabscript/` - Vendored transpiler fallback
- `vscode-extension/syntaxes/tabscript.tmLanguage.json` - TextMate grammar

## Architecture
- `src/tabscript.ts` - Main entry, exports `transpile()` and plugin types
- `src/parser.ts` - Recursive descent parser, all `parse*()` methods, `Parser` class
- `src/state.ts` - Input/output state, token reading, `State` class with snapshot/revert
- `src/cli.ts` - CLI with `--output`, `--debug`, `--recover`, `--js`, `--whitespace` flags
- `src/browser.ts` - Browser runtime, auto-transpiles `<script type="text/tabscript">` tags

### Plugin System

Load via `import plugin "path"`. Plugin exports default function `(parser, options)` that augments `parse*` methods on `parser`:

```ts
const MY_PATTERN = parser.pattern(/myregex/, 'Name');
const orig = parser.parseStatement.bind(p);
parser.parseStatement = (s) => {
    if (s.read(MY_PATTERN)) { s.emit('/* output */'); return true; }
    return orig(s);
};
```

Insert before/after similar precedence methods. Avoid wrapping core methods like `parseExpression`, instead choose something more specific like `parseSwitch`. See `tests/markup-plugin.tab`, `tests/log-plugin.tab`.

### Parser Details

Recursive descent with backtracking (`snapshot()`/`revert()`), indent/dedent tokens (generated by `readNewline()`), sticky-mode regexes, sourcemap position tracking, error recovery via `recoverErrors()`.

## Tests

Diff-based: `tests/test.{tab,ts,js}` (core), `tests/error.{tab,ts}` (recovery), `tests/markup.*` (UI plugin), `tests/log.*` (logging plugin).

## Development

Parser changes: Add syntax to test file, update `parse*()` in `src/parser.ts`, run `npm test`.

### Browser Testing (Playwright MCP)

Start server: `python -m http.server 8765`. **CRITICAL**: Clear cache before tests:
```javascript
const client = await page.context().newCDPSession(page);
await client.send('Network.clearBrowserCache');
await page.goto(`http://127.0.0.1:8765/tests/browser/?v=${Date.now()}`);
```

### State API (plugins)

`s.read(pattern...)` - Consume tokens, `s.emit(str...)` - Add output, `s.accept(pattern...)` - Read+emit, `s.acceptType(pattern...)` - Like accept but suppressed in JS mode, `s.peek(pattern...)` - Read then revert, `s.snapshot()` - Get revert handle, `s.must(value)` - Throw if falsy, `s.parseGroup(opts, func)` - Parse groups, `s.recoverErrors(func)` - Error recovery.

Parser methods: Return truthy on success, falsy on failure. Leave state unchanged on failure.

Debug: `--debug` shows tokens, check `matchOptions` in errors.
